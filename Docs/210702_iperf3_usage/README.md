# iperf3 における最高速度の測定方法メモ
`2021/07/02 登`


- iperf は Linux 上で人気の高いスループット測定ツールであるが、パラメータの最適な設定が十分でなく、本来の NW 性能を正しく測定していない例が散見される。また、iperf 固有のバグにより、測定結果の読み取りを誤ったり、そもそも特定 OS で LAN 上であっても性能が出ないことが確認されているモードが存在したりする。このように、iperf の利用は、思ったよりも比較的難易度が高いのである。

- そこで、本文書では、登の経験をもとに、ほぼすべてのネットワーク (LAN、WAN、VPN 等) で、回線速度を最も正確に測定するコマンド例を示す。


# 共通的な注意事項
1. iperf を利用するときは、できる限り、Linux 版を利用する。iperf の Windows 版は、動作が不安定である。これは cygwin 上でコンパイルされているが、cygwin の socket スタックの出来が良くなく、挙動が不安定になったり、おかしなエラーが発生したりするのである。
2. iperf を利用するときは、できる限り、TCP を用いて測定を実施する。iperf の TCP の測定結果は、正確である。一方、UDP の測定結果は、集計結果に明らかに誤りがあり (0 bps などと表示される)、結果の読み取り方に癖がある。したがって、TCP を用いることを推奨する。
3. Windows 版 iperf の UDP は、受信側の socket の不具合 (cygwin の recvfrom() の不具合であると思われる) により、著しく CPU 使用率が高まり、最新の Intel の CPU でも 500Mbps 程度しか受信速度を測定することができないので、注意すること。UDP を用いて測定するときは、できる限り Windows を利用せず、Linux を利用すること。どうしても Windows を利用する場合は、TCP を用いることを強く推奨する。
4. iperf で TCP よりも UDP の結果が著しく低い場合は、上記の不具合を踏んでいるか、または使用方法に誤りがある。
5. iperf の待受け側 (サーバー側) は時々不安定になる。この場合は、一度、Ctrl + C を押して iperf プロセスを終了してから、再度起動すること。このように、iperf は色々と出来が良くない点があるが、うまく測定できているときはとても快調なのである。
6. iperf の動作前に、すべてのパケットフィルタやファイアウォール (iptables 等) のルールはクリアしておくこと。また、経路上にパケットフィルタやファイアウォールが存在してはならない。


# 準備
## Linux (例: Ubuntu)
```
apt-get -y update && apt-get -y install iperf3
```

## Windows
Win32 版バイナリが https://iperf.fr/iperf-download.php よりダウンロード可能である。  
ただし、Windows 版は上記で述べている不具合があるので、十分警戒して利用しなければならない。


# iperf3 サーバー側の起動
iperf3 の測定サーバー (待受け側) で、以下のようにして iperf3 を起動する。

SSH 上で起動すると、SSH コンソールを終了してしまうと iperf3 サーバーが停止してしまう。そこで、screen 上で起動する等をお勧めする。

```

iperf3 --server --udp-counters-64bit --format m

```

# iperf3 クライアント側の実行 (TCP)
## TCP: 送信: クライアント → サーバー (クライアントからみて TX 方向)
- 下記のように実行する。  
  (下記のコマンド例で、`192.168.0.1` の部分を、サーバーの IP アドレスに置換すること。)
- すると、15 秒間計測が行なわれる。
- 最後に表示される `[SUM]` の `receiver` の `Mbits/sec` の値が結果である。

```

iperf3 --client 192.168.0.1 --length 1M -b 0 --parallel 32 --no-delay --time 15

```


## TCP: 受信: サーバー → クライアント (クライアントからみて RX 方向)
- 下記のように実行する。  
  (下記のコマンド例で、`192.168.0.1` の部分を、サーバーの IP アドレスに置換すること。)
- すると、15 秒間計測が行なわれる。
- 最後に表示される `[SUM]` の `receiver` の `Mbits/sec` の値が結果である。

```

iperf3 --client 192.168.0.1 --length 1M -b 0 --parallel 32 --window 16M --no-delay --reverse --time 15

```

# iperf3 クライアント側の実行 (UDP)
## UDP: 送信: クライアント → サーバー (クライアントからみて TX 方向)

- 下記のように実行する。  
  (下記のコマンド例で、`192.168.0.1` の部分を、サーバーの IP アドレスに置換すること。)
- すると、15 秒間計測が行なわれる。
- 測定中に表示される `Mbits/sec` の値は、単なる送信側の送付速度 (クライアント側でみた速度) なので、これは全く無意味である。(常に 1Gbps とかになるはずである。)
- 測定後に表示される `Server output:` の後の 15 秒間分の `Bandwidth` の `Mbits/sec` の値が、受信側 (サーバー側) でみた受信速度 (つまり、求めている値) である。これは 1 秒ごとに 15 行 (つまり、15 秒分) 表示される。したがって、これらが正しい速度測定結果である。
- ところが、一番最後の行に合計値として、なんと `Transfer 0.00 Bytes、Bandwidth 0.00 Mbits/sec` などと表示される。これは iperf のバグである。したがって、一番最後の行の合計値はあてにならない。まったくひどいものである。このような理由で、UDP モードの利用は推奨されない。
```

iperf3 --client 192.168.0.1 --udp -b 0 --window 16M --udp-counters-64bit --get-server-output --length 1394 --time 15

```

## UDP: 受信: サーバー → クライアント (クライアントからみて RX 方向)
- 下記のように実行する。  
  (下記のコマンド例で、`192.168.0.1` の部分を、サーバーの IP アドレスに置換すること。)
- すると、15 秒間計測が行なわれる。
- 測定中に表示される 15 秒間の Bandwidth の「Mbits/sec」の値が、受信側 (クライアント側) でみた受信速度である。これは 1 秒ごとに 15 行 (つまり、15 秒分) 表示される。したがって、これらが正しい速度測定結果である。
- ところが、一番最後の行に合計値として `Transfer XX Gbytes、Bandwidth XX Gbits/sec` と表示される。これは iperf のバグである。計算を誤っているものと考えられる。したがって、一番最後の行の合計値はあてにならない。まったくひどいものである。このような理由で、UDP モードの利用は推奨されない。
```

iperf3 --client 192.168.0.1 --udp -b 0 --window 16M --udp-counters-64bit --reverse --length 1394 --time 15

```


糸冬了！！
