このファイルは、このプロジェクトで作成するプログラムの全体仕様・目的を記述したものである。

1. このプログラムの目的
(1) このブログラムは、軽量なコマンドラインプロセスであり、実行する度に、以下の処理を実施することを目標としている。
(2) このプログラムは、ユーザーの自己の「POP3 メールボックス」に届いている新着メールを、ユーザーの自己の「Gmail メールボックス」にインポートすることを実現する。これにより、「POP3 メールボックス」のメールアドレス宛に届いたメールがあるとき、「Gmail メールボックス」にあたかも新着メールが届いたのと同様の取扱いで、「Gmail メールボックス」にメールが受信された挙動を実現する。
  1 個の「POP3 メールボックス」と 1 個の「Gmail メールボックス」をサポートするだけで足りる。
(3) (2) について、ユーザーは、常に電源が入っている任意の Linux マシン (Ubuntu 24.04 を想定) 上で、cron または supervisord 等の仕組みを用いて、本プログラムを 60 秒程度に 1 回呼び出すことにより、自動的・バックグラウンド的に (2) を定期実行することを予定している。
  ここで、本プログラムは、処理の結果、特に問題がなかった場合は、標準エラー出力に一切何も表示せず、プロセス戻り値は 0 を返さなければならない。他方で、処理の結果、たとえば、プロトコルエラーや認証エラー、Gmail の API が異常なエラーを返したような場合は、その旨の例外を標準エラー出力に記載するとともに、プロセス戻り値は 0 以外 (明示的に戻り値を指定する場合は「1」) を返さなければならない。ユーザーは、標準エラー出力の内容を、別途 syslog 等に記録し、これを確認することにより、エラーに気付くことができるのである。



2. このプログラムの動作モード
(1) このプログラムの、エントリポイント (Main 関数) は、「251218_K3VRU3 コマンドラインユーティリティ」パターンによって実装すること。

(2) プロセス起動時のコマンドライン引数による指定により、ユーザーは、以下の 2 つの動作モードのうち、いずれかを選択する。いずれのモードも指定されていない場合は、UNIX コマンドラインの伝統に合う懇切丁寧なコマンドライン引数ヘルプメッセージ (英語で記載すること) を出力し、エラーコード 1 で終了すること。

  (a) 「Gmail OAuth トークン取得モード」 (gettoken モード) [F3QBRBA9]
    - コマンドライン: 「gettoken --saveas <結果初期トークンJSONファイル> --client_id <Gmail API に対して予めユーザが登録しておいたクライアントアプリ ID> --client_secret <クライアントシークレット> --port <ポート番号>」
    - このモードは、ユーザーが、Windows または Linux 上の、自分のデスクトップ環境上で、コマンドラインから手動で呼び出して実行するモードである。ユーザーは、本プログラムの使用を開始する際に、1 回だけ、これを用いて、対象の「Gmail メールボックス」のアカウントに OAuth 接続して初期トークンを取得する。
    - このモードでは、ユーザーは、「デスクトップ / ネイティブアプリ向けの loopback (localhost 受け取り) 方式」で OAuth 初期トークンを取得できる。より具体的な手順は、次のとおりである。
      (i) ユーザーが gettoken を実行すると、プログラムは、一時的に、<ポート番号> で指定された 127.0.0.1 に TCP バインドされた HTTP サーバーを起動させる。この HTTP サーバーは、とても軽量な HTTP サーバーであり、Kestrel のような重厚なフレームワーク (外部ライブラリ) を必要とせず、SSL を必要としない生の HTTP サーバーを実装すること。HTTP サーバーが立ち上がったら、標準出力に、「http://127.0.0.1:<ポート番号>/start」・・・ [FSGX2FQ2] への接続を促すメッセージを出すこと。
      (ii) ユーザーが [FSGX2FQ2] にローカルマシンの Web ブラウザでアクセスすると、認証処理を開始する旨の簡単な案内の HTML が表示される。ここで「Start」のようなボタンがあり、ユーザーがこれをクリックすると、ハイパーリンクになっており、Google の「https://accounts.google.com/o/oauth2/auth」 (あるいは現在におけるより新しいURLがある場合はそのURL) に OAuth 接続手順により認証トークンを取得しにいくためのクエリ文字列を追加した形のURLにジャンプするようになっている。
      ここで、Scope は、「gmail.modify」とする。詳しくは Gmail API のベストプラクティスを参照すること。
      (iii) ユーザーが認証を終えると、「http://127.0.0.1:<ポート番号>/auth_callback」に処理が戻ってくる (ユーザーは予め <Gmail API に対して予めユーザが登録しておいたクライアントアプリ ID>、<クライアントシークレット>、「http://127.0.0.1:<ポート番号>/auth_callback」 を Google Deverlopers Console から Gmail のクライアントとして登録してあることを想定)。
      (iv) 認証結果を、<結果初期トークンJSONファイル> として書き出す。JSON 書式は [EG8R7RTE] とする。そのファイルに書き出した旨の案内メッセージを HTTP サーバーでユーザーに丁寧で面白みのある暖かい HTML で表示し、Web ブラウザを閉じて良い旨の記載とともに、Web ブラウザを閉じるためのボタンも用意する。
      (v) ユーザーは、このプロセスを、Ctrl + C などの普通の手段で強制終了する。

  (b) 「メール転送実施モード」 (forward モード)
    - これについては、別途後述する。




91. Gmail との OAuth トークン情報 JSON ファイルの書式 [EG8R7RTE]
--- ここから ---
public class GMailOAuthTokenJsonData
{
    public DateTimeOffset LastRefreshDt; // 最後に更新された日時
    public string AppClientId; // クライアントアプリ ID
    public string AppClientSecret; // クライアントシークレット
    public string UserAccessToken; // アクセストークン (必要に応じて更新される)
}
--- ここまで ---




