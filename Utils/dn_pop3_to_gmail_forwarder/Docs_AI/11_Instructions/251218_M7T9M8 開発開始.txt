251218_M7W6MP:
本プロジェクトの開発を開始する。
まず、[F3QBRBA9] の機能を実装せよ。

251218_PYG4DH:
コーディング規約に追加した「111. テキスト処理 [WUZK8R3U]」を適用せよ。

251218_QULZF4:
コーディング規約に追加した「111. テキスト処理 [WUZK8R3U]」を適用せよ。

251218_QX4C82:
コーディング規約に追加した「101. JSON [PV4U3JTR]」を適用せよ。この部分について、共通的ライブラリ処理として [BZAMWB56], [E64UYSSZ] に従って切り出せ。

251218_SUH8JS:
Main() で起動時に "Hello World" と表示するコードを先頭に追加。

251218_VZU2SN:
メール転送実施モード [AC579L84] を実装せよ。

251218_X738HN:
設定ファイル [A44FBNFX] に新設された項目「ssl_trusted_static_hash_list」に対応せよ。

251218_XLVF4A:
[YU4CRZ2B] と [KDXFFA9U] の点を改良せよ。

251218_XTD4PS:
[CQVFZY4W] の行の仕様を変更したので、適用せよ。

251218_YG7589:
[WZZM4P46] メール取得上の注意 を適用せよ。

251218_YG5XK4:
[SS9R4XHX] のメールアドレス文字列の抽出を実施せよ。

251218_YQ78RE:
[N9YQARM8] を実施せよ。すなわち、インポート時は、neverMarkSpam=True オプションを有効にすること。

251218_ZFT79R:
[ULP8TK5N] の機能を追加せよ。

251223_AGV8BB:
メールフィルタ [251222_ZXH7N7] の機能を追加せよ。

251223_AQCX8B:
「設定検査モード」 (check モード) [251222_ZYMQ4U] を追加せよ。

251223_BBAX3A:
現在、filter_csharp_filename で指定するユーザーフィルタ関数は、[251223_BBEK4Q] のように、MailForwardFilterResult および MailForwardFilterParam というクラスの参照につき、ネームスペース dn_pop3_to_gmail_forwarder を明示で指定する必要が生じている。これは煩雑である。そこで、LibMailFilterExec の実装を改良し、ユーザーコードのコンパイルに際しては、ネームスペース dn_pop3_to_gmail_forwarder を暗黙に using しているものとみなしてコンパイルするような改良を施せ。
--- [251223_BBEK4Q] ここから ---
public static class UserFilterClass
{
    public static dn_pop3_to_gmail_forwarder.MailForwardFilterResult UserFilter(dn_pop3_to_gmail_forwarder.MailForwardFilterParam mail)
    {
        dn_pop3_to_gmail_forwarder.MailForwardFilterResult result = new();

        // ここで mail の内容を検査して何らかのフィルタ処理を実施

        result.MarkAsRead = true;

        result.LabelList.Add("Label1");
        result.LabelList.Add("Label2");

        return result;
    }
}
--- ここまで ---


251223_BVHM5V:

以下の不具合を解決せよ。

(1) 以下の [251223_BVUDR6] という user filter を定義して試したところ、Gmail へのインポート時に [251223_BVA9DF] という API エラーが出てしまう。Gmail には「Label1」というラベルは確かに存在する。

原因は、Gmail API の labelIds が「ラベル名」ではなく「ラベルID」を要求する点です。
現在の実装は MailForwardFilterResult.LabelList の文字列をそのまま labelIds に入れているため、Label1（名前）が渡り Invalid label になります。システムラベルは INBOX/UNREAD がIDとして通るため問題が見えにくいですが、ユーザーラベルは通常 Label_XXXX のようなIDなので弾かれます。補足: システムメッセージのインポートでも同じ labelIds を使っているため、そこでエラーになっています。

(2) 対処策
- Gmail API を呼び出す際に、users.labels.list を呼び、ラベル名→ ID へ変換してから labelIds に設定すること。
- この際、指定されたラベルが、仮にまだ存在していない場合は、作成操作をすること。


--- [251223_BVUDR6] ここから ---
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;

public static class UserFilterClass
{
    public static MailForwardFilterResult UserFilter(MailForwardFilterParam mail)
    {
        MailForwardFilterResult result = new();

        // ここで mail の内容を検査して何らかのフィルタ処理を実施

        result.MarkAsRead = true;

        result.LabelList.Add("Label1");

        return result;
    }
}

--- [251223_BVUDR6] ここまで ---

--- [251223_BVA9DF] ここから ---
2025/12/23 01:42:10.402 +09:00 [Error] APPERROR: Failed to import system message to Gmail. / Detail: System.Exception: APPERROR: Gmail API users.messages.import (system message) returned 400 Bad Request. Body: { /   "error": { /     "code": 400, /     "message": "Invalid label: Label1", /     "errors": [ /       { /         "message": "Invalid label: Label1", /         "domain": "global", /         "reason": "invalidArgument" /       } /     ], /     "status": "INVALID_ARGUMENT" /   } / } /  /    at dn_pop3_to_gmail_forwarder.FeatureForward.GmailApiImportAsync(ForwardConfig config, String accessToken, Byte[] rawMail, MailMetaData meta, MailForwardFilterResult filterResult, CancellationToken cancel) in C:\git\IPA-DN-Misc\Utils\dn_pop3_to_gmail_forwarder\feature_forward.cs:line 1644

--- [251223_BVA9DF] ここまで ---


251223_CTSHY7:
以下の不具合を解決せよ。
ユーザーフィルタに、[251223_CTX6LY] のように書かれているとする。そして、Label4も、Label5も、まだGmailには存在しないとする。Gmailにおいては、ラベル名階層構造は、実際には「/」で区切られたラベル名のリストとして内部的構造を有している (詳しくはGmailのAPIドキュメント等を参照せよ)。そして[251223_CTX6LY]のような例では、まず"Label4"を作り(まだ無ければ)、その後、"Label4/Label5"を作る、ということが必要とされる。すなわち、指定されたラベル名を「/」で区切ったところ、"(a)/(b)/(c)"となっていたとすると、"(a)","(a)/(b)","(a)/(b)/(c)"という3種類のラベルが、まだなければ、作成されなければならない。これをしないと、GmailのUI上で、階層構造がなされない。これを行なうコードを追加せよ。
--- [251223_CTX6LY] ここから ---
        result.LabelList.Add("Label4/Label5");
--- [251223_CTX6LY] ここまで ---

251223_DGDTM9:
Gmail の「フィルタ」の現在設定を filter.cs にマージする作業。
(1) Gmail の「フィルタ」機能で、現在設定されているフィルタを Gmail の「フィルタを XML エクスポート」した 「user_filter/secret_gmail_filter.txt」ファイルがある。
(2) 現在、手作りで作ってきている「user_filter/filter.cs」という C# ベースのユーザーフィルタファイルがある。
(3) そこで、(1) のフィルタを、C# に変換し、(2) の現在 [251223_DHK69G] で囲まれている領域にマージせよ。
    - この際、(1) の XML メールフィルタの各 entry における以下の項目をみること。
      -- 条件:
        -- from 条件。これは、m.AddressList_From?.Address のアドレスを検査することで、同様に判定できる。大文字小文字は区別しないべきである。
        -- to 条件。これは、m.AddressList_To のいずれか 1 つにでも Address のアドレスに含まれているかどうかで判定すべきである。大文字小文字は区別しないべきである。
        -- subject 条件。これは、m.Subject の文字列を検査することで、同様に判定できる。大文字小文字は区別しないべきである。
        -- hasTheWord 条件。これは、m.HtmlBodyToPlainText または m.PlainTextBody に指定した文字列が含まれるかどうかで判定できる。大文字小文字は区別しないべきである。
      -- 動作:
        -- shouldMarkAsRead が付いていれば、result.MarkAsRead = true にする。
        -- label が付いていれば、result.LabelList.Add する。

251224_BFFPY2:
アーカイブにおける gzip 圧縮機能 [251224_BEXKU2] を実装せよ。

251224_BPM9EB:
仕様において、[251224_BPAZU4] というタグを記載した点につき、YYMMDD → YYYYMMDD への変更を行なったので、コード側もこれにあわせて修正せよ。

251224_CSX3SZ:
仕様の [251224_CKS4SV] の部分の機能を新たに実装せよ。

251224_DDW5RW:
仕様の [251224_DDQDE9] の部分の機能を新たに実装せよ。

251224_VNJQF4:
仕様の [251224_VMWE23] を確実に適用せよ。必須パラメータのチェックを厳格に。

